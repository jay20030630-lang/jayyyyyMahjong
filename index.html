<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>éº»å°‡å¤§å¸«è¨ˆåˆ†å™¨ PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { 
            background-color: #f8fafc; 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        .tab-active { color: #059669; position: relative; }
        .tab-active::after { content: ''; position: absolute; bottom: 0; left: 25%; width: 50%; height: 4px; background: #059669; border-radius: 10px; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .member-chip { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .member-chip.active { background-color: #059669; color: white; transform: scale(1.05); box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); }
        #sync-indicator { position: fixed; top: 1rem; right: 1rem; z-index: 100; pointer-events: none; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #059669; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <!-- åŒæ­¥ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    <div id="sync-indicator" class="flex items-center gap-2 bg-white/90 px-3 py-1.5 rounded-full shadow-lg border hidden">
        <div class="loading-spinner"></div>
        <span class="text-xs font-bold text-emerald-700">åŒæ­¥ä¸­...</span>
    </div>

    <div class="max-w-md mx-auto min-h-screen flex flex-col bg-white shadow-xl relative">
        
        <!-- Header -->
        <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b px-6 py-4 flex justify-between items-center">
            <h1 class="text-xl font-black tracking-tight text-slate-800">MAHJONG MASTER</h1>
            <div id="connection-status" class="w-2.5 h-2.5 rounded-full bg-slate-300"></div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow p-5 pb-24 overflow-x-hidden">
            
            <!-- 1. æ•¸æ“šç¸½è¦½ (Dashboard) -->
            <section id="page-dashboard" class="page-content space-y-5">
                <div class="bg-gradient-to-br from-emerald-600 to-teal-700 rounded-[2.5rem] p-7 text-white shadow-2xl shadow-emerald-100">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <p class="text-xs font-bold opacity-80 mb-1 uppercase tracking-widest">ç¸½æ”¶ç›Šæ¦‚è¦½</p>
                            <h2 id="dashNet" class="text-5xl font-black tracking-tighter">$ 0</h2>
                        </div>
                        <select id="dashYearSelect" onchange="updateDashboard()" class="bg-white/20 border-none rounded-xl px-3 py-1.5 text-xs font-black backdrop-blur-md">
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white/10 rounded-2xl p-4">
                            <p class="text-[10px] font-bold opacity-70 mb-1">ç¸½è´å ´é‡‘é¡</p>
                            <p id="dashWin" class="text-xl font-black text-emerald-100">$ 0</p>
                        </div>
                        <div class="bg-white/10 rounded-2xl p-4">
                            <p class="text-[10px] font-bold opacity-70 mb-1">ç¸½è¼¸å ´é‡‘é¡</p>
                            <p id="dashLoss" class="text-xl font-black text-red-200">$ 0</p>
                        </div>
                    </div>
                </div>

                <!-- æ—¥æ›†çµ„ä»¶ -->
                <div class="bg-white rounded-[2rem] p-6 border shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="calTitle" class="font-black text-slate-800">2026å¹´ 1æœˆ</h3>
                        <div class="flex gap-1">
                            <button onclick="changeMonth(-1)" class="p-2 hover:bg-slate-100 rounded-full font-bold">â®</button>
                            <button onclick="changeMonth(1)" class="p-2 hover:bg-slate-100 rounded-full font-bold">â¯</button>
                        </div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-2 text-center text-[10px] font-bold text-slate-400 mb-2">
                        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                    </div>
                    <div id="calendarDays" class="grid grid-cols-7 gap-2"></div>
                </div>

                <!-- æœ€è¿‘ç´€éŒ„ -->
                <div class="space-y-3">
                    <h3 class="font-black text-slate-800 px-1">æœ€è¿‘ç´€éŒ„</h3>
                    <div id="recentMatchesList" class="space-y-3"></div>
                </div>
            </section>

            <!-- 2. è¨ˆåˆ†å·¥å…· (Tracker) -->
            <section id="page-tracker" class="page-content hidden">
                <!-- è¨­å®šç•«é¢ -->
                <div id="setupView" class="space-y-6">
                    <div class="bg-white rounded-[2.5rem] p-8 border shadow-sm space-y-8">
                        <h2 class="text-3xl font-black text-slate-800">é–‹å±€è¨­å®š</h2>
                        
                        <div class="space-y-5">
                            <div>
                                <label class="text-xs font-black text-slate-400 mb-2 block ml-1">é¸æ“‡ç‰Œå’– (é¸ä¸‰ä½)</label>
                                <div id="setupMemberList" class="flex gap-4 overflow-x-auto pb-4 no-scrollbar"></div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-slate-50 p-4 rounded-3xl border border-slate-100">
                                    <label class="text-[10px] font-black text-slate-400 block mb-1">åº• (Base)</label>
                                    <input type="number" id="betBase" placeholder="100" class="bg-transparent w-full text-xl font-black focus:outline-none">
                                </div>
                                <div class="bg-slate-50 p-4 rounded-3xl border border-slate-100">
                                    <label class="text-[10px] font-black text-slate-400 block mb-1">å° (Rate)</label>
                                    <input type="number" id="betRate" placeholder="20" class="bg-transparent w-full text-xl font-black focus:outline-none">
                                </div>
                            </div>

                            <div class="bg-slate-50 p-4 rounded-3xl border border-slate-100">
                                <label class="text-[10px] font-black text-slate-400 block mb-1">æ¯”è³½æ—¥æœŸ</label>
                                <input type="date" id="setupDate" class="bg-transparent w-full font-bold focus:outline-none">
                            </div>
                        </div>

                        <button onclick="startMatch()" class="w-full bg-slate-900 text-white py-6 rounded-[2rem] font-black text-lg shadow-xl active:scale-95 transition-transform">
                            é–‹å§‹ç´€éŒ„ç‰Œå±€
                        </button>
                    </div>
                </div>

                <!-- è¨˜éŒ„ç•«é¢ -->
                <div id="recordView" class="hidden space-y-5">
                    <div class="bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden">
                        <div class="relative z-10">
                            <p class="text-xs font-bold opacity-50 mb-1">ç›®å‰æœ¬äººç¸½å‹è² </p>
                            <h2 id="liveNet" class="text-6xl font-black tracking-tighter">$ 0</h2>
                        </div>
                        <div class="absolute -right-10 -bottom-10 w-40 h-40 bg-emerald-500/20 rounded-full blur-3xl"></div>
                    </div>

                    <div class="bg-white rounded-[2.5rem] p-6 border shadow-sm space-y-6">
                        <div class="flex bg-slate-100 p-1.5 rounded-2xl">
                            <button onclick="setRecType('win')" id="btn-win" class="flex-1 py-3 rounded-xl font-black text-sm transition-all bg-white shadow-sm text-emerald-600">èƒ¡/æ‘¸ (+)</button>
                            <button onclick="setRecType('loss')" id="btn-loss" class="flex-1 py-3 rounded-xl font-black text-sm transition-all text-slate-400">æ§/æ‘¸ (-)</button>
                        </div>

                        <div id="targetPicker" class="flex gap-3 overflow-x-auto py-1"></div>

                        <div class="flex gap-3">
                            <div class="flex-1 bg-slate-50 p-4 rounded-2xl border flex items-center">
                                <span class="font-black text-slate-400 mr-2">$</span>
                                <input type="number" id="recVal" placeholder="é‡‘é¡" class="bg-transparent w-full font-black text-xl focus:outline-none">
                            </div>
                            <button onclick="addLog()" class="bg-slate-900 text-white px-8 rounded-2xl font-black">åŠ å…¥</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-[2.5rem] p-6 border shadow-sm">
                        <h3 class="font-black text-slate-800 mb-4 flex justify-between items-center">
                            <span>å³æ™‚ç´€éŒ„æµ</span>
                            <span id="logCount" class="text-xs bg-slate-100 px-2 py-1 rounded-md text-slate-500">0 ç­†</span>
                        </h3>
                        <div id="logList" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
                        <div class="mt-6 pt-6 border-t flex gap-3">
                            <button onclick="cancelMatch()" class="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-black text-sm">å–æ¶ˆ</button>
                            <button onclick="confirmSettle()" class="flex-[2] py-4 bg-orange-500 text-white rounded-2xl font-black text-sm shadow-lg shadow-orange-100">çµç®—æ­¤å±€</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. æˆå“¡ç®¡ç† (Members) -->
            <section id="page-members" class="page-content hidden space-y-6">
                <div class="bg-white rounded-[2.5rem] p-8 border shadow-sm">
                    <h2 class="text-2xl font-black text-slate-800 mb-6">æ–°å¢æˆå“¡</h2>
                    <div class="flex gap-3">
                        <input type="text" id="memName" placeholder="æˆå“¡ç¨±å‘¼" class="flex-1 p-5 bg-slate-50 rounded-2xl border-none font-bold focus:ring-2 ring-emerald-500">
                        <button onclick="addMember()" class="bg-emerald-600 text-white py-5 px-8 rounded-2xl font-black shadow-lg">æ–°å¢</button>
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="font-black text-slate-800 px-1">æˆå“¡æ•¸æ“šç¸½è¦½</h3>
                    <div id="memberListDisplay" class="space-y-4"></div>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/90 backdrop-blur-xl border-t flex safe-bottom z-50">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="flex-1 py-4 flex flex-col items-center gap-1 font-bold text-xs text-slate-400 transition-all">
                <span class="text-xl">ğŸ“Š</span> æ•¸æ“š
            </button>
            <button onclick="switchTab('tracker')" id="tab-tracker" class="flex-1 py-4 flex flex-col items-center gap-1 font-bold text-xs text-slate-400 transition-all">
                <span class="text-xl">ğŸ€„</span> è¨ˆåˆ†
            </button>
            <button onclick="switchTab('members')" id="tab-members" class="flex-1 py-4 flex flex-col items-center gap-1 font-bold text-xs text-slate-400 transition-all">
                <span class="text-xl">ğŸ‘¥</span> æˆå“¡
            </button>
        </nav>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // --- è¨­å®šèˆ‡ç‹€æ…‹ ---
        const appId = "mahjong-master-v10-final";
        const firebaseConfig = {
            apiKey: "AIzaSyAX-Lsh3RdVZWf6oV5TAH-OS4BD__h4DuQ",
            authDomain: "mahjong-scoring-calculat-3c0ca.firebaseapp.com",
            projectId: "mahjong-scoring-calculat-3c0ca",
            storageBucket: "mahjong-scoring-calculat-3c0ca.firebasestorage.app",
            messagingSenderId: "386600276534",
            appId: "1:386600276534:web:2eefd6ee6eba7ae9927e97"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let DB = { members: [], matches: [] };
        let user = null;
        let activeMatch = null;
        let currentTab = 'dashboard';
        let viewDate = new Date();
        
        // æš«å­˜ç‹€æ…‹
        let setupSelectedIds = [];
        let recordType = 'win'; // 'win' or 'loss'
        let recordTargetId = null;

        // --- åŒæ­¥é‚è¼¯ (é—œéµä¿®å¾©) ---

        function showSync(show) {
            const el = document.getElementById('sync-indicator');
            if (show) el.classList.remove('hidden');
            else setTimeout(() => el.classList.add('hidden'), 500);
        }

        async function saveToCloud() {
            if (!user) return;
            showSync(true);
            try {
                await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).set({
                    mahjongDB: DB,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) {
                console.error("åŒæ­¥å¤±æ•—", e);
            } finally {
                showSync(false);
            }
        }

        // åˆå§‹åŒ–èˆ‡ç›£è½
        auth.signInAnonymously().then(cred => {
            user = cred.user;
            document.getElementById('connection-status').className = "w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]";
            
            // é‡è¦ï¼šé€™è£¡å•Ÿå‹•å…¨æ™‚ç›£è½
            db.collection('artifacts').doc(appId).collection('users').doc(user.uid)
            .onSnapshot(doc => {
                if (doc.exists && doc.data().mahjongDB) {
                    DB = doc.data().mahjongDB;
                    console.log("é›²ç«¯è³‡æ–™å·²æ›´æ–°ï¼Œæ­£åœ¨åŒæ­¥ç•«é¢...");
                    renderCurrentPage();
                }
            });
        });

        // --- åˆ†é èˆ‡å°èˆª ---
        window.switchTab = function(tab) {
            currentTab = tab;
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('tab-active', 'text-slate-900');
                b.classList.add('text-slate-400');
                if (b.id === `tab-${tab}`) {
                    b.classList.add('tab-active', 'text-slate-900');
                }
            });
            renderCurrentPage();
        };

        function renderCurrentPage() {
            if (currentTab === 'dashboard') updateDashboard();
            if (currentTab === 'tracker') {
                if (!activeMatch) renderSetup();
                else updateRecordUI();
            }
            if (currentTab === 'members') renderMemberList();
        }

        // --- ç¸½è¦½åŠŸèƒ½ ---
        function updateDashboard() {
            const select = document.getElementById('dashYearSelect');
            const years = [...new Set(DB.matches.map(m => m.date.split('-')[0]))];
            if (years.length === 0) years.push(new Date().getFullYear().toString());
            select.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');

            const targetYear = select.value;
            const yearMatches = DB.matches.filter(m => m.date.startsWith(targetYear));
            
            let win = 0, loss = 0;
            yearMatches.forEach(m => {
                if (m.total > 0) win += m.total;
                else loss += Math.abs(m.total);
            });

            document.getElementById('dashNet').innerText = `$ ${(win - loss).toLocaleString()}`;
            document.getElementById('dashWin').innerText = `$ ${win.toLocaleString()}`;
            document.getElementById('dashLoss').innerText = `$ ${loss.toLocaleString()}`;

            renderCalendar();
            renderRecentMatches();
        }

        function renderCalendar() {
            const container = document.getElementById('calendarDays');
            const y = viewDate.getFullYear(), m = viewDate.getMonth();
            document.getElementById('calTitle').innerText = `${y}å¹´ ${m + 1}æœˆ`;
            container.innerHTML = '';

            const firstDay = new Date(y, m, 1).getDay();
            const lastDate = new Date(y, m + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) container.appendChild(document.createElement('div'));

            for (let d = 1; d <= lastDate; d++) {
                const ds = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dailyMatches = DB.matches.filter(mt => mt.date === ds);
                const dailyNet = dailyMatches.reduce((acc, mt) => acc + mt.total, 0);

                const el = document.createElement('div');
                el.className = `h-10 flex flex-col items-center justify-center rounded-xl text-xs font-black transition-all cursor-pointer`;
                
                if (dailyMatches.length > 0) {
                    el.className += dailyNet >= 0 ? ' bg-emerald-500 text-white' : ' bg-red-500 text-white';
                } else {
                    el.className += ' bg-slate-50 text-slate-400 hover:bg-slate-100';
                }
                el.innerText = d;
                container.appendChild(el);
            }
        }

        window.changeMonth = (s) => { viewDate.setMonth(viewDate.getMonth() + s); renderCalendar(); };

        function renderRecentMatches() {
            const list = document.getElementById('recentMatchesList');
            const recent = DB.matches.slice(0, 5);
            if (recent.length === 0) {
                list.innerHTML = `<div class="text-center py-10 text-slate-300 font-bold">å°šç„¡ç´€éŒ„</div>`;
                return;
            }
            list.innerHTML = recent.map(m => `
                <div class="bg-white p-5 rounded-3xl border flex justify-between items-center shadow-sm">
                    <div>
                        <p class="text-xs font-bold text-slate-400">${m.date}</p>
                        <p class="font-black text-slate-700">ç‰Œå±€çµç®—</p>
                    </div>
                    <p class="text-xl font-black ${m.total >= 0 ? 'text-emerald-600' : 'text-red-600'}">
                        ${m.total >= 0 ? '+' : ''}${m.total.toLocaleString()}
                    </p>
                </div>
            `).join('');
        }

        // --- è¨ˆåˆ†å·¥å…·åŠŸèƒ½ ---
        function renderSetup() {
            const list = document.getElementById('setupMemberList');
            list.innerHTML = DB.members.map(m => `
                <div onclick="toggleSetupId('${m.id}')" class="member-chip flex-shrink-0 cursor-pointer ${setupSelectedIds.includes(m.id) ? 'active' : ''}">
                    <div class="w-16 h-16 bg-white border-2 rounded-[1.5rem] flex items-center justify-center font-black text-lg mb-1">
                        ${m.name.substring(0,2)}
                    </div>
                    <p class="text-[10px] font-bold text-center text-slate-500">${m.name}</p>
                </div>
            `).join('');
            document.getElementById('setupDate').valueAsDate = new Date();
        }

        window.toggleSetupId = function(id) {
            if (setupSelectedIds.includes(id)) setupSelectedIds = setupSelectedIds.filter(i => i !== id);
            else if (setupSelectedIds.length < 3) setupSelectedIds.push(id);
            renderSetup();
        };

        window.startMatch = function() {
            if (setupSelectedIds.length !== 3) return alert("è«‹å…ˆé¸æ“‡ä¸‰ä½ç‰Œå’–");
            const date = document.getElementById('setupDate').value;
            const base = parseInt(document.getElementById('betBase').value) || 0;
            const rate = parseInt(document.getElementById('betRate').value) || 0;

            activeMatch = {
                date, base, rate,
                players: DB.members.filter(m => setupSelectedIds.includes(m.id)),
                logs: [],
                scores: {}, // ç´€éŒ„æ¯å€‹äººé€™å±€çš„æ·¨å‹è² 
                total: 0 // æœ¬äººçš„ç¸½å‹è² 
            };
            activeMatch.players.forEach(p => activeMatch.scores[p.id] = 0);

            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('recordView').classList.remove('hidden');
            updateRecordUI();
        };

        window.setRecType = function(type) {
            recordType = type;
            const isWin = type === 'win';
            document.getElementById('btn-win').className = isWin ? 'flex-1 py-3 rounded-xl font-black text-sm transition-all bg-white shadow-sm text-emerald-600' : 'flex-1 py-3 rounded-xl font-black text-sm transition-all text-slate-400';
            document.getElementById('btn-loss').className = !isWin ? 'flex-1 py-3 rounded-xl font-black text-sm transition-all bg-white shadow-sm text-red-600' : 'flex-1 py-3 rounded-xl font-black text-sm transition-all text-slate-400';
        };

        function updateRecordUI() {
            document.getElementById('liveNet').innerText = `$ ${activeMatch.total.toLocaleString()}`;
            document.getElementById('logCount').innerText = `${activeMatch.logs.length} ç­†`;
            
            // ç›®æ¨™é¸æ“‡å™¨ (åŒ…å«æœ¬äºº)
            const targetPicker = document.getElementById('targetPicker');
            const players = [...activeMatch.players, { id: 'self', name: 'è‡ªæ‘¸/è¢«æ‘¸' }];
            targetPicker.innerHTML = players.map(p => `
                <button onclick="recordTargetId='${p.id}';updateRecordUI()" class="flex-shrink-0 px-5 py-2.5 rounded-xl font-black text-sm border-2 transition-all ${recordTargetId === p.id ? 'bg-slate-900 border-slate-900 text-white' : 'bg-white text-slate-400'}">
                    ${p.name}
                </button>
            `).join('');

            // ç´€éŒ„æ¸…å–®
            const logList = document.getElementById('logList');
            logList.innerHTML = activeMatch.logs.slice().reverse().map((l, idx) => `
                <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100">
                    <div>
                        <p class="text-xs font-bold text-slate-400">${l.type}</p>
                        <p class="font-black text-slate-700">${l.targetName}</p>
                    </div>
                    <p class="font-black ${l.score >= 0 ? 'text-emerald-600' : 'text-red-600'}">${l.score >= 0 ? '+' : ''}${l.score}</p>
                </div>
            `).join('');
        }

        window.addLog = function() {
            const val = parseInt(document.getElementById('recVal').value) || 0;
            if (val === 0) return;
            if (!recordTargetId) return alert("è«‹é¸æ“‡å°è±¡");

            let logEntry = { type: '', targetName: '', score: 0 };
            const isWin = recordType === 'win';

            if (recordTargetId === 'self') {
                // è‡ªæ‘¸æˆ–è¢«è‡ªæ‘¸
                if (isWin) {
                    logEntry.type = "è‡ªæ‘¸ (æœ¬äºº)";
                    logEntry.targetName = "ä¸‰å®¶æ”¯ä»˜";
                    logEntry.score = val * 3;
                    activeMatch.total += (val * 3);
                    activeMatch.players.forEach(p => activeMatch.scores[p.id] -= val);
                } else {
                    logEntry.type = "è¢«æ‘¸ (æœ¬äºº)";
                    logEntry.targetName = "æ”¯ä»˜ä¸€å®¶";
                    logEntry.score = -val;
                    activeMatch.total -= val;
                    activeMatch.players.forEach(p => activeMatch.scores[p.id] += (val/3)); // é€™è£¡é‚è¼¯è¦–è¦å‰‡èª¿æ•´
                }
            } else {
                // è·Ÿç‰¹å®šæŸäºº èƒ¡/æ§
                const target = activeMatch.players.find(p => p.id === recordTargetId);
                logEntry.targetName = target.name;
                if (isWin) {
                    logEntry.type = "èƒ¡ç‰Œ (æœ¬äºº)";
                    logEntry.score = val;
                    activeMatch.total += val;
                    activeMatch.scores[target.id] -= val;
                } else {
                    logEntry.type = "æ”¾æ§ (æœ¬äºº)";
                    logEntry.score = -val;
                    activeMatch.total -= val;
                    activeMatch.scores[target.id] += val;
                }
            }

            activeMatch.logs.push(logEntry);
            document.getElementById('recVal').value = '';
            updateRecordUI();
        };

        window.confirmSettle = async function() {
            if (!confirm("ç¢ºå®šè¦çµç®—ä¸¦å­˜æª”å—ï¼Ÿé€™å°‡æœƒæ›´æ–°æ‰€æœ‰æˆå“¡æ•¸æ“šã€‚")) return;
            
            // 1. å­˜å…¥ç‰Œå±€ç¸½è¡¨
            DB.matches.unshift({
                id: Date.now(),
                date: activeMatch.date,
                total: activeMatch.total,
                details: activeMatch.logs
            });

            // 2. æ›´æ–°åƒèˆ‡æˆå“¡çš„å€‹äººç´€éŒ„
            activeMatch.players.forEach(p => {
                const dbM = DB.members.find(m => m.id === p.id);
                if (dbM) {
                    if (!dbM.records) dbM.records = [];
                    dbM.records.push({
                        date: activeMatch.date,
                        score: activeMatch.scores[p.id]
                    });
                }
            });

            activeMatch = null;
            await saveToCloud();
            
            document.getElementById('recordView').classList.add('hidden');
            document.getElementById('setupView').classList.remove('hidden');
            switchTab('dashboard');
        };

        window.cancelMatch = function() {
            if (confirm("è¦å–æ¶ˆç›®å‰ç´€éŒ„å—ï¼Ÿè³‡æ–™å°‡ä¸æœƒè¢«å„²å­˜ã€‚")) {
                activeMatch = null;
                document.getElementById('recordView').classList.add('hidden');
                document.getElementById('setupView').classList.remove('hidden');
            }
        };

        // --- æˆå“¡ç®¡ç†åŠŸèƒ½ ---
        window.addMember = async function() {
            const name = document.getElementById('memName').value.trim();
            if (!name) return;
            
            DB.members.push({
                id: 'm_' + Date.now(),
                name: name,
                records: [],
                createdAt: new Date().toISOString()
            });

            document.getElementById('memName').value = '';
            await saveToCloud();
            renderMemberList();
        };

        function renderMemberList() {
            const display = document.getElementById('memberListDisplay');
            if (DB.members.length === 0) {
                display.innerHTML = `<div class="text-center py-20 text-slate-300 font-bold">ç›®å‰æ²’æœ‰æˆå“¡</div>`;
                return;
            }

            display.innerHTML = DB.members.map(m => {
                const total = (m.records || []).reduce((acc, r) => acc + r.score, 0);
                const winRate = m.records ? Math.round((m.records.filter(r => r.score > 0).length / m.records.length) * 100) || 0 : 0;
                
                return `
                <div class="bg-white p-6 rounded-[2rem] border shadow-sm flex justify-between items-center group active:scale-[0.98] transition-all">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-slate-100 rounded-2xl flex items-center justify-center font-black text-slate-500">
                            ${m.name.substring(0,2)}
                        </div>
                        <div>
                            <p class="font-black text-slate-800">${m.name}</p>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">å‹ç‡ ${winRate}%</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-black ${total >= 0 ? 'text-emerald-600' : 'text-red-600'}">
                            ${total >= 0 ? '+' : ''}${total.toLocaleString()}
                        </p>
                        <p class="text-[10px] font-bold text-slate-300">ç¸½è¨ˆå‹è² </p>
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            switchTab('dashboard');
        };
    </script>
</body>
</html>
