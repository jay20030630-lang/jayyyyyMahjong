<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>麻將大師計分器 (極速同步版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { 
            background-color: #f1f5f9; 
            font-family: 'Noto Sans TC', sans-serif; 
            padding-bottom: env(safe-area-inset-bottom);
            touch-action: manipulation; 
        }
        .tab-active { color: #059669; border-bottom: 4px solid #059669; }
        .calendar-day { aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.875rem; cursor: pointer; position: relative; transition: all 0.2s; }
        .day-win { background-color: #22c55e !important; color: white; }
        .day-loss { background-color: #ef4444 !important; color: white; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
        #loading-overlay { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .bet-active { background-color: #059669 !important; color: white !important; }
    </style>
</head>
<body>
    <!-- 載入中遮罩 -->
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mb-4"></div>
        <p class="font-bold text-slate-500">正在連接雲端數據庫...</p>
    </div>

    <div class="max-w-md mx-auto min-h-screen flex flex-col shadow-2xl bg-slate-50 relative overflow-hidden">
        <!-- 導航欄位 -->
        <nav class="sticky top-0 z-40 bg-white/95 backdrop-blur shadow-sm flex border-b">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="flex-1 py-4 font-black text-center text-slate-400">總覽</button>
            <button onclick="switchTab('tracker')" id="tab-tracker" class="flex-1 py-4 font-black text-center text-slate-400">計分</button>
            <button onclick="switchTab('members')" id="tab-members" class="flex-1 py-4 font-black text-center text-slate-400">成員</button>
        </nav>

        <main class="p-4 flex-grow overflow-x-hidden">
            <!-- 數據總覽頁面 -->
            <section id="page-dashboard" class="page-content hidden space-y-4">
                <div class="glass-card rounded-3xl p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-slate-800">數據統計</h3>
                        <select id="dashYearSelect" onchange="updateDashboard()" class="bg-slate-100 border-none rounded-lg px-2 py-1 text-sm font-bold"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div id="netProfitBox" class="col-span-2 rounded-2xl p-5 text-center text-white bg-emerald-600">
                            <p class="text-[10px] opacity-70 font-bold uppercase">總淨勝負</p>
                            <h2 id="dashNet" class="text-4xl font-black mt-1 tracking-tighter">$ 0</h2>
                        </div>
                        <div class="bg-white rounded-2xl p-3 border text-center">
                            <p class="text-[10px] text-slate-400 font-bold">總贏額</p>
                            <p id="dashWin" class="text-xl font-black text-emerald-600">$ 0</p>
                        </div>
                        <div class="bg-white rounded-2xl p-3 border text-center">
                            <p class="text-[10px] text-slate-400 font-bold">總輸額</p>
                            <p id="dashLoss" class="text-xl font-black text-red-600">$ 0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="calTitle" class="font-black text-slate-800">2026年 1月</h3>
                        <div class="flex gap-2">
                            <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full font-bold">◀</button>
                            <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full font-bold">▶</button>
                        </div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
                </div>
            </section>

            <!-- 牌局計分頁面 -->
            <section id="page-tracker" class="page-content hidden">
                <div id="setupView" class="space-y-4">
                    <div class="bg-white rounded-3xl p-6 shadow-sm space-y-6">
                        <h2 class="text-2xl font-black text-slate-800">建立新牌局</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] font-black text-slate-400">日期</label>
                                <input type="date" id="setupDate" class="w-full p-4 bg-slate-50 rounded-2xl font-bold border-0">
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 mb-2 block">選擇牌咖 (三位)</label>
                                <div id="setupMemberList" class="flex gap-3 overflow-x-auto pb-2 min-h-[80px]"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <input type="number" id="betBase" placeholder="底" class="p-4 bg-slate-50 rounded-2xl font-bold">
                                <input type="number" id="betRate" placeholder="台" class="p-4 bg-slate-50 rounded-2xl font-bold">
                            </div>
                        </div>
                        <button onclick="startMatch()" class="w-full bg-emerald-600 text-white py-5 rounded-[24px] font-black shadow-xl">開始計分</button>
                    </div>
                </div>

                <div id="recordView" class="hidden space-y-4">
                    <div class="bg-slate-900 text-white rounded-[32px] p-8 text-center">
                        <p class="text-[10px] font-bold opacity-50">目前總勝負</p>
                        <h2 id="liveNet" class="text-6xl font-black mt-1 tracking-tighter">$ 0</h2>
                    </div>
                    <div class="bg-white rounded-[32px] p-6 shadow-sm space-y-4">
                        <select id="recType" class="w-full p-4 bg-slate-100 rounded-2xl font-black">
                            <option value="胡牌">胡牌 (+)</option>
                            <option value="自摸">自摸 (+)</option>
                            <option value="放槍">放槍 (-)</option>
                            <option value="被自摸">被自摸 (-)</option>
                        </select>
                        <input type="number" id="recVal" placeholder="輸入金額" class="w-full p-4 bg-slate-100 rounded-2xl font-black">
                        <div id="recTargetList" class="flex gap-2 overflow-x-auto py-2"></div>
                        <button onclick="addLog()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black">記錄結果</button>
                    </div>
                    <div class="bg-white rounded-[32px] p-6 shadow-sm">
                        <div id="logList" class="space-y-2 mb-6"></div>
                        <button onclick="confirmSettle()" class="w-full bg-orange-500 text-white py-4 rounded-2xl font-black">結算並儲存</button>
                    </div>
                </div>
            </section>

            <!-- 成員管理頁面 -->
            <section id="page-members" class="page-content hidden space-y-6">
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <h2 class="text-xl font-black text-slate-800 mb-4">新增成員</h2>
                    <div class="flex gap-3">
                        <input type="text" id="memName" placeholder="成員姓名" class="flex-1 p-4 bg-slate-50 rounded-2xl border-none font-bold">
                        <button onclick="addMember()" class="bg-emerald-600 text-white py-4 px-6 rounded-2xl font-black shadow-md">新增</button>
                    </div>
                </div>
                <div id="memberListDisplay" class="space-y-3"></div>
            </section>
        </main>
    </div>

    <!-- Firebase SDK (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // --- 核心變數 ---
        let DB = { members: [], matches: [] };
        let activeMatch = null;
        let user = null;
        let viewDate = new Date();
        const appId = "mahjong-pro-v5-sync";
        let setupSelectedMembers = [];
        let selectedRecMember = null;

        const firebaseConfig = {
            apiKey: "AIzaSyAX-Lsh3RdVZWf6oV5TAH-OS4BD__h4DuQ",
            authDomain: "mahjong-scoring-calculat-3c0ca.firebaseapp.com",
            projectId: "mahjong-scoring-calculat-3c0ca",
            storageBucket: "mahjong-scoring-calculat-3c0ca.firebasestorage.app",
            messagingSenderId: "386600276534",
            appId: "1:386600276534:web:2eefd6ee6eba7ae9927e97"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 同步核心邏輯 ---

        // 1. 寫入雲端
        function saveCloud() {
            if (!user) return;
            console.log("正在同步至雲端...");
            db.collection('artifacts').doc(appId).collection('users').doc(user.uid).set({
                mahjongDB: DB,
                lastSync: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                console.log("雲端同步成功");
            }).catch(err => {
                console.error("同步失敗:", err);
            });
        }

        // 2. 匿名登入並啟動即時監聽
        auth.signInAnonymously().then(cred => {
            user = cred.user;
            // 啟動監聽：只要雲端有任何變動，立即更新本地 DB 並重新渲染
            db.collection('artifacts').doc(appId).collection('users').doc(user.uid)
            .onSnapshot(doc => {
                if (doc.exists && doc.data().mahjongDB) {
                    console.log("接收到雲端更新");
                    DB = doc.data().mahjongDB;
                    refreshCurrentUI();
                }
                document.getElementById('loading-overlay').style.display = 'none';
            }, err => {
                console.error("監聽失敗:", err);
                document.getElementById('loading-overlay').innerHTML = `<p class="text-red-500 font-bold">連線失敗，請重新整理</p>`;
            });
        });

        // 3. 重新整理 UI 邏輯 (F5 後會呼叫這個)
        function refreshCurrentUI() {
            const hash = window.location.hash.replace('#', '') || 'dashboard';
            initYearSelects();
            if (hash === 'dashboard') updateDashboard();
            if (hash === 'tracker') {
                if (!activeMatch) renderSetupMembers();
                else updateRecordUI();
            }
            if (hash === 'members') renderMemberList();
        }

        // --- 分頁切換 ---
        window.switchTab = function(tab) {
            window.location.hash = tab; // F5 後靠這個讀取位置
            document.querySelectorAll('.page-content').forEach(s => s.classList.add('hidden'));
            document.getElementById(`page-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('tab-active', 'text-slate-400');
                if (b.id === `tab-${tab}`) b.classList.add('tab-active');
                else b.classList.add('text-slate-400');
            });
            refreshCurrentUI();
        };

        // --- 功能模組 ---

        function initYearSelects() {
            const years = ['all', ...new Set(DB.matches.map(m => m.date.split('-')[0]))];
            const curY = new Date().getFullYear().toString();
            if (!years.includes(curY)) years.push(curY);
            years.sort((a,b) => b === 'all' ? 1 : b - a);
            const el = document.getElementById('dashYearSelect');
            if (el) {
                const prev = el.value;
                el.innerHTML = years.map(y => `<option value="${y}">${y === 'all' ? '全部' : y + '年'}</option>`).join('');
                el.value = prev || curY;
            }
        }

        window.updateDashboard = function() {
            const year = document.getElementById('dashYearSelect').value;
            const filtered = DB.matches.filter(m => year === 'all' || m.date.startsWith(year));
            let win = 0, loss = 0;
            filtered.forEach(m => {
                if (m.total > 0) win += m.total;
                else loss += Math.abs(m.total);
            });
            const net = win - loss;
            document.getElementById('dashNet').innerText = `$ ${net.toLocaleString()}`;
            document.getElementById('netProfitBox').className = `col-span-2 rounded-2xl p-5 text-center text-white ${net >= 0 ? 'bg-emerald-600' : 'bg-red-600'}`;
            document.getElementById('dashWin').innerText = `$ ${win.toLocaleString()}`;
            document.getElementById('dashLoss').innerText = `$ ${loss.toLocaleString()}`;
            renderCalendar();
        };

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const y = viewDate.getFullYear(), m = viewDate.getMonth();
            document.getElementById('calTitle').innerText = `${y}年 ${m + 1}月`;
            grid.innerHTML = '';
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m+1, 0).getDate();
            for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const net = DB.matches.filter(m => m.date === dateStr).reduce((acc, m) => acc + m.total, 0);
                const count = DB.matches.filter(m => m.date === dateStr).length;
                const el = document.createElement('div');
                el.className = `calendar-day font-bold ${count > 0 ? (net >= 0 ? 'day-win' : 'day-loss') : 'bg-white text-slate-300'}`;
                el.innerText = d;
                grid.appendChild(el);
            }
        }

        window.changeMonth = function(step) {
            viewDate.setMonth(viewDate.getMonth() + step);
            renderCalendar();
        };

        // --- 成員功能 ---
        window.addMember = function() {
            const name = document.getElementById('memName').value.trim();
            if (!name) return;
            DB.members.push({ id: 'mem_'+Date.now(), name, records: [] });
            document.getElementById('memName').value = '';
            saveCloud(); // 關鍵：立即寫入雲端
            renderMemberList();
        };

        window.renderMemberList = function() {
            const display = document.getElementById('memberListDisplay');
            display.innerHTML = DB.members.map(m => {
                const total = m.records.reduce((acc, r) => acc + r.score, 0);
                return `
                <div class="p-5 rounded-2xl bg-white border flex justify-between items-center shadow-sm">
                    <p class="font-black text-slate-800">${m.name}</p>
                    <p class="font-black ${total >= 0 ? 'text-emerald-600' : 'text-red-600'}">${total >= 0 ? '+' : ''}${total.toLocaleString()}</p>
                </div>`;
            }).join('');
        };

        // --- 計分功能簡化版 ---
        window.renderSetupMembers = function() {
            const list = document.getElementById('setupMemberList');
            list.innerHTML = DB.members.map(m => `
                <div onclick="toggleSetupMember('${m.id}')" class="flex-shrink-0 text-center cursor-pointer">
                    <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-xs font-bold transition-all border-2 ${setupSelectedMembers.includes(m.id) ? 'border-emerald-500 bg-emerald-50' : 'bg-white border-transparent shadow-sm'}">
                        ${m.name.substring(0,2)}
                    </div>
                </div>`).join('');
        };

        window.toggleSetupMember = function(id) {
            if (setupSelectedMembers.includes(id)) setupSelectedMembers = setupSelectedMembers.filter(i => i !== id);
            else if (setupSelectedMembers.length < 3) setupSelectedMembers.push(id);
            renderSetupMembers();
        };

        window.startMatch = function() {
            if (setupSelectedMembers.length !== 3) return alert("請選擇三位成員");
            activeMatch = {
                date: document.getElementById('setupDate').value,
                members: DB.members.filter(m => setupSelectedMembers.includes(m.id)),
                logs: [], overallTotal: 0, memberScores: {}
            };
            activeMatch.members.forEach(m => activeMatch.memberScores[m.name] = 0);
            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('recordView').classList.remove('hidden');
            updateRecordUI();
        };

        window.addLog = function() {
            const val = parseInt(document.getElementById('recVal').value) || 0;
            const type = document.getElementById('recType').value;
            if (!selectedRecMember && type !== '自摸') return alert("請選擇目標");
            
            let score = 0;
            const m = activeMatch.members.find(x => x.id === selectedRecMember);
            
            if (type === '胡牌') { score = val; activeMatch.memberScores[m.name] -= val; }
            if (type === '放槍') { score = -val; activeMatch.memberScores[m.name] += val; }
            if (type === '自摸') { score = val * 3; activeMatch.members.forEach(x => activeMatch.memberScores[x.name] -= val); }
            if (type === '被自摸') { score = -val; activeMatch.memberScores[m.name] += val; }

            activeMatch.overallTotal += score;
            activeMatch.logs.push({ type, score, target: m ? m.name : '三家' });
            document.getElementById('recVal').value = '';
            updateRecordUI();
        };

        window.updateRecordUI = function() {
            document.getElementById('liveNet').innerText = `$ ${activeMatch.overallTotal}`;
            document.getElementById('recTargetList').innerHTML = activeMatch.members.map(m => `
                <button onclick="selectedRecMember='${m.id}';updateRecordUI()" class="px-4 py-2 rounded-xl font-bold ${selectedRecMember===m.id?'bg-slate-900 text-white':'bg-slate-100 text-slate-400'}">${m.name}</button>
            `).join('');
            document.getElementById('logList').innerHTML = activeMatch.logs.slice().reverse().map(l => `
                <div class="flex justify-between p-2 border-b text-sm"><span>${l.target} (${l.type})</span><span class="font-bold">${l.score}</span></div>
            `).join('');
        };

        window.confirmSettle = function() {
            DB.matches.unshift({ date: activeMatch.date, total: activeMatch.overallTotal });
            activeMatch.members.forEach(m => {
                const dbM = DB.members.find(x => x.id === m.id);
                dbM.records.push({ date: activeMatch.date, score: activeMatch.memberScores[m.name] });
            });
            activeMatch = null;
            saveCloud();
            document.getElementById('recordView').classList.add('hidden');
            document.getElementById('setupView').classList.remove('hidden');
            switchTab('dashboard');
        };

        window.onload = () => {
            document.getElementById('setupDate').valueAsDate = new Date();
            const tab = window.location.hash.replace('#', '') || 'dashboard';
            switchTab(tab);
        };
    </script>
</body>
</html>
