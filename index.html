<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éº»å°‡å¤§å¸«è¨ˆåˆ†å™¨ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { 
            background-color: #f8fafc; 
            font-family: 'Noto Sans TC', sans-serif; 
            padding-bottom: env(safe-area-inset-bottom);
            touch-action: manipulation; 
        }
        .tab-active { color: #059669; border-bottom: 4px solid #059669; }
        .calendar-day { aspect-ratio: 1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.875rem; cursor: pointer; position: relative; transition: all 0.2s; }
        .day-win { background-color: #22c55e !important; color: white; }
        .day-loss { background-color: #ef4444 !important; color: white; }
        .member-card { transition: all 0.2s; cursor: pointer; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .bet-active { background-color: #059669 !important; color: white !important; }
        #loading-overlay { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .emoji-btn { font-size: 1.5rem; padding: 0.5rem; border-radius: 0.5rem; transition: background 0.2s; }
        .emoji-btn.selected { background-color: #ecfdf5; border: 2px solid #10b981; }
    </style>
</head>
<body>
    <!-- è¼‰å…¥é®ç½© -->
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mb-4"></div>
        <p class="font-bold text-slate-500">é›²ç«¯åŒæ­¥ä¸­...</p>
    </div>

    <div class="max-w-md mx-auto min-h-screen flex flex-col shadow-2xl bg-slate-50 relative">
        <!-- å°è¦½åˆ— -->
        <nav class="sticky top-0 z-40 bg-white shadow-sm flex border-b">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="flex-1 py-4 font-black text-center text-slate-400 tab-active">ç¸½è¦½</button>
            <button onclick="switchTab('tracker')" id="tab-tracker" class="flex-1 py-4 font-black text-center text-slate-400">è¨ˆåˆ†</button>
            <button onclick="switchTab('members')" id="tab-members" class="flex-1 py-4 font-black text-center text-slate-400">æˆå“¡</button>
        </nav>

        <main class="p-4 flex-grow overflow-x-hidden">
            <!-- ç¸½è¦½é é¢ -->
            <section id="page-dashboard" class="page-content space-y-4">
                <div class="glass-card rounded-3xl p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-slate-800">ç´¯è¨ˆç›ˆè™§</h3>
                        <select id="dashYearSelect" onchange="updateDashboard()" class="bg-slate-100 rounded-lg px-2 py-1 text-sm font-bold"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div id="netProfitBox" class="col-span-2 rounded-2xl p-5 text-center text-white bg-emerald-600">
                            <p class="text-[10px] opacity-70 font-bold uppercase">æ·¨å‹è² </p>
                            <h2 id="dashNet" class="text-4xl font-black mt-1">$ 0</h2>
                        </div>
                        <div class="bg-emerald-50 rounded-2xl p-3 border border-emerald-100 text-center">
                            <p class="text-[10px] text-emerald-600 font-bold">ç¸½è´</p>
                            <p id="dashWin" class="text-xl font-black text-emerald-700">$ 0</p>
                        </div>
                        <div class="bg-red-50 rounded-2xl p-3 border border-red-100 text-center">
                            <p class="text-[10px] text-red-600 font-bold">ç¸½è¼¸</p>
                            <p id="dashLoss" class="text-xl font-black text-red-700">$ 0</p>
                        </div>
                        <div class="bg-blue-50 rounded-2xl p-3 border border-blue-100 text-center">
                            <p class="text-[10px] text-blue-600 font-bold">å ´æ¬¡</p>
                            <p id="dashMatches" class="text-xl font-black text-blue-700">0</p>
                        </div>
                        <div class="bg-purple-50 rounded-2xl p-3 border border-purple-100 text-center">
                            <p class="text-[10px] text-purple-600 font-bold">å‹ç‡</p>
                            <p id="dashWinRate" class="text-xl font-black text-purple-700">0%</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="calTitle" class="font-black text-slate-800">2025å¹´ 1æœˆ</h3>
                        <div class="flex gap-2">
                            <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full font-bold">â—€</button>
                            <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full font-bold">â–¶</button>
                        </div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
                </div>
            </section>

            <!-- è¨ˆåˆ†é é¢ -->
            <section id="page-tracker" class="page-content hidden">
                <!-- å»ºç«‹ç‰Œå±€ -->
                <div id="setupView" class="space-y-4">
                    <div class="bg-white rounded-3xl p-6 shadow-sm space-y-6">
                        <h2 class="text-2xl font-black text-slate-800">å»ºç«‹ç‰Œå±€</h2>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] font-black text-slate-400">æ—¥æœŸ</label>
                                    <input type="date" id="setupDate" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-0">
                                </div>
                                <div>
                                    <label class="text-[10px] font-black text-slate-400">åœ°é»</label>
                                    <input type="text" id="setupLoc" placeholder="è¼¸å…¥åœ°é»" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-0">
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 mb-2 block">é¸æ“‡ç‰Œå’– (é¸ä¸‰ä½)</label>
                                <div id="setupMemberList" class="flex gap-3 overflow-x-auto pb-2 scroll-hide min-h-[80px]"></div>
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 mb-2 block">é¸æ“‡è³­æ³¨</label>
                                <div class="grid grid-cols-4 gap-2 mb-2">
                                    <button onclick="setBet(30,10,this)" class="bet-btn py-3 bg-slate-100 rounded-xl text-xs font-black">30/10</button>
                                    <button onclick="setBet(50,20,this)" class="bet-btn py-3 bg-slate-100 rounded-xl text-xs font-black">50/20</button>
                                    <button onclick="setBet(100,20,this)" class="bet-btn py-3 bg-slate-100 rounded-xl text-xs font-black">100/20</button>
                                    <button onclick="setBet('custom','',this)" class="bet-btn py-3 bg-slate-100 rounded-xl text-xs font-black">è‡ªè¨‚</button>
                                </div>
                                <div id="customBetArea" class="hidden grid grid-cols-2 gap-4">
                                    <input type="number" id="betBase" placeholder="åº•" class="p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                                    <input type="number" id="betRate" placeholder="å°" class="p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                                </div>
                            </div>
                        </div>
                        <button onclick="startMatch()" class="w-full bg-emerald-600 text-white py-5 rounded-[24px] font-black text-lg shadow-xl active:scale-95 transition-all">é–‹å§‹ç‰Œå±€</button>
                    </div>
                </div>

                <!-- è¨ˆåˆ†é€²è¡Œä¸­ -->
                <div id="recordView" class="hidden space-y-4">
                    <div class="bg-slate-900 text-white rounded-[32px] p-8 shadow-2xl text-center">
                        <p class="text-[10px] font-bold opacity-50 tracking-widest">ç›®å‰å‹è² </p>
                        <h2 id="liveNet" class="text-6xl font-black mt-1">$ 0</h2>
                        <div class="flex justify-between mt-4 opacity-70 text-[10px] font-bold">
                            <span id="liveRoundInfo">ç¬¬ 1 å°‡</span>
                            <span id="liveBetInfo">---</span>
                        </div>
                    </div>
                    <div class="bg-white rounded-[32px] p-6 shadow-sm space-y-4">
                        <select id="recType" onchange="toggleRecTypeUI()" class="w-full p-4 bg-slate-100 rounded-2xl font-black outline-none">
                            <option value="èƒ¡ç‰Œ">èƒ¡ç‰Œ</option>
                            <option value="è‡ªæ‘¸">è‡ªæ‘¸</option>
                            <option value="æ”¾æ§">æ”¾æ§</option>
                            <option value="è¢«è‡ªæ‘¸">è¢«è‡ªæ‘¸</option>
                        </select>
                        
                        <div id="selfDrawInputArea" class="hidden space-y-3">
                            <div class="flex justify-between items-center px-1">
                                <label class="text-[10px] font-black text-slate-400">çµ¦ä»˜é‡‘é¡</label>
                                <button onclick="syncSelfDrawValues()" class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-1 rounded-md font-black">åŒä¸Šæ¬„ä½</button>
                            </div>
                            <div id="selfDrawFields" class="space-y-3"></div>
                        </div>

                        <div id="normalInputArea" class="space-y-3">
                            <input type="number" id="recVal" placeholder="è¼¸å…¥é‡‘é¡" class="w-full p-4 bg-slate-100 rounded-2xl font-black outline-none">
                            <div id="recTargetList" class="flex gap-2 overflow-x-auto py-2 scroll-hide"></div>
                        </div>

                        <button onclick="addLog()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black shadow-lg">è¨˜éŒ„</button>
                    </div>

                    <div class="bg-white rounded-[32px] p-6 shadow-sm">
                        <h3 class="font-black text-slate-800 mb-4">æœ¬å°‡æ˜ç´°</h3>
                        <div id="logList" class="space-y-2 max-h-64 overflow-y-auto pr-2"></div>
                        <div class="grid grid-cols-2 gap-3 mt-6">
                            <button onclick="nextRound()" class="bg-slate-100 text-slate-500 py-4 rounded-2xl font-black">ä¸‹ä¸€å°‡</button>
                            <button onclick="confirmSettle()" class="bg-orange-500 text-white py-4 rounded-2xl font-black shadow-lg">çµç®—ç‰Œå±€</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- æˆå“¡é é¢ -->
            <section id="page-members" class="page-content hidden space-y-6">
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <h2 class="text-xl font-black text-slate-800 mb-4">å»ºç«‹æˆå“¡</h2>
                    <div id="emojiGrid" class="grid grid-cols-5 gap-2 mb-4 overflow-y-auto max-h-40 p-2 bg-slate-50 rounded-xl"></div>
                    <div class="flex gap-3">
                        <input type="text" id="memName" placeholder="æˆå“¡åå­—" class="flex-1 p-4 bg-slate-50 rounded-2xl border-none font-bold outline-none">
                        <button onclick="addMember()" class="bg-emerald-600 text-white px-6 rounded-2xl font-black">æ–°å¢</button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center px-2">
                        <h3 class="font-black text-slate-800">æˆå“¡åˆ—è¡¨</h3>
                        <select id="memYearSelect" onchange="renderMemberList()" class="bg-white border-none rounded-lg px-2 py-1 text-xs font-bold shadow-sm"></select>
                    </div>
                    <div id="memberListDisplay" class="space-y-3 pb-8"></div>
                </div>
            </section>
        </main>

        <!-- å½ˆçª—æ¨¡æ…‹æ¡† -->
        <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal()"></div>
            <div class="bg-white w-full max-w-sm rounded-[40px] shadow-2xl relative z-10 p-8 max-h-[90vh] overflow-y-auto">
                <div id="modalContent"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // --- åˆå§‹åŒ– Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyAX-Lsh3RdVZWf6oV5TAH-OS4BD__h4DuQ",
            authDomain: "mahjong-scoring-calculat-3c0ca.firebaseapp.com",
            projectId: "mahjong-scoring-calculat-3c0ca",
            storageBucket: "mahjong-scoring-calculat-3c0ca.firebasestorage.app",
            messagingSenderId: "386600276534",
            appId: "1:386600276534:web:2eefd6ee6eba7ae9927e97"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "mahjong_stats_v1";

        // --- å…¨åŸŸè®Šæ•¸ ---
        let DB = { members: [], matches: [] };
        let user = null;
        let viewDate = new Date();
        const animals = ['ğŸ¶','ğŸ±','ğŸ¹','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸµ','ğŸ”','ğŸ¦„','ğŸ','ğŸ¦–','ğŸ™','ğŸ‘½','ğŸ‘»','ğŸ¯'];
        let selectedEmoji = animals[0];
        let setupSelectedMembers = [];
        let activeMatch = null;
        let selectedRecMember = null;
        let selectedBet = { base: 0, rate: 0 };

        // --- æ ¸å¿ƒé‚è¼¯ ---
        window.onload = async () => {
            initEmojiGrid();
            document.getElementById('setupDate').valueAsDate = new Date();
            
            auth.onAuthStateChanged(async (u) => {
                if (u) {
                    user = u;
                    fetchData();
                } else {
                    await auth.signInAnonymously();
                }
            });
        };

        async function fetchData() {
            db.collection('artifacts').doc(appId).collection('users').doc(user.uid).onSnapshot(doc => {
                if (doc.exists && doc.data().mahjongDB) {
                    DB = doc.data().mahjongDB;
                    refreshUI();
                }
                document.getElementById('loading-overlay').style.display = 'none';
            });
        }

        async function saveCloud() {
            if (!user) return;
            await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).set({
                mahjongDB: DB,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        function refreshUI() {
            initYearSelects();
            updateDashboard();
            renderMemberList();
            renderSetupMembers();
        }

        function switchTab(tab) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${tab}`).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('tab-active');
                if (b.id === `tab-${tab}`) b.classList.add('tab-active');
            });
            refreshUI();
        }

        // --- ç¸½è¦½åŠŸèƒ½ ---
        function initYearSelects() {
            const currentYear = new Date().getFullYear();
            const years = ['all', ...new Set(DB.matches.map(m => m.date.split('-')[0]))];
            if (!years.includes(currentYear.toString())) years.push(currentYear.toString());
            years.sort((a,b) => b === 'all' ? 1 : b - a);

            const selects = ['dashYearSelect', 'memYearSelect'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const val = el.value || currentYear.toString();
                el.innerHTML = years.map(y => `<option value="${y}">${y === 'all' ? 'å…¨ç¨‹ç´¯è¨ˆ' : y + ' å¹´'}</option>`).join('');
                el.value = val;
            });
        }

        function updateDashboard() {
            const year = document.getElementById('dashYearSelect').value;
            const filtered = DB.matches.filter(m => year === 'all' || m.date.startsWith(year));
            
            let winTotal = 0, lossTotal = 0, winCount = 0;
            filtered.forEach(m => {
                if (m.total > 0) { winTotal += m.total; winCount++; }
                else if (m.total < 0) lossTotal += Math.abs(m.total);
            });

            const net = winTotal - lossTotal;
            document.getElementById('dashNet').innerText = `$ ${net.toLocaleString()}`;
            document.getElementById('netProfitBox').className = `col-span-2 rounded-2xl p-5 text-center text-white ${net >= 0 ? 'bg-emerald-600' : 'bg-red-600'}`;
            document.getElementById('dashWin').innerText = `$ ${winTotal.toLocaleString()}`;
            document.getElementById('dashLoss').innerText = `$ ${lossTotal.toLocaleString()}`;
            document.getElementById('dashMatches').innerText = filtered.length;
            document.getElementById('dashWinRate').innerText = filtered.length > 0 ? Math.round((winCount/filtered.length)*100)+'%' : '0%';
            
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const y = viewDate.getFullYear(), m = viewDate.getMonth();
            document.getElementById('calTitle').innerText = `${y}å¹´ ${m + 1}æœˆ`;
            grid.innerHTML = '';

            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m+1, 0).getDate();

            for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const daysMatches = DB.matches.filter(m => m.date === dateStr);
                const dailyNet = daysMatches.reduce((acc, m) => acc + m.total, 0);

                const el = document.createElement('div');
                el.className = `calendar-day font-bold ${daysMatches.length > 0 ? (dailyNet >= 0 ? 'day-win' : 'day-loss') : 'bg-white text-slate-300'}`;
                el.innerText = d;
                el.onclick = () => showDailyMatches(dateStr);
                grid.appendChild(el);
            }
        }

        function changeMonth(dir) {
            viewDate.setMonth(viewDate.getMonth() + dir);
            renderCalendar();
        }

        // --- è¨ˆåˆ†åŠŸèƒ½ ---
        function initEmojiGrid() {
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = animals.map(e => `<button onclick="selectEmoji('${e}', this)" class="emoji-btn ${e === selectedEmoji ? 'selected' : ''}">${e}</button>`).join('');
        }

        function selectEmoji(e, btn) {
            selectedEmoji = e;
            document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        function renderSetupMembers() {
            const list = document.getElementById('setupMemberList');
            if (DB.members.length === 0) {
                list.innerHTML = `<p class="text-slate-400 text-sm py-4">å°šæœªæ–°å¢ä»»ä½•æˆå“¡</p>`;
                return;
            }
            list.innerHTML = DB.members.map(m => `
                <div onclick="toggleSetupMember('${m.id}')" class="flex-shrink-0 text-center cursor-pointer">
                    <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-2xl transition-all border-2 ${setupSelectedMembers.includes(m.id) ? 'border-emerald-500 bg-emerald-50' : 'border-transparent bg-white shadow-sm'}">
                        ${m.emoji}
                    </div>
                    <p class="text-[10px] font-bold mt-1 ${setupSelectedMembers.includes(m.id) ? 'text-emerald-600' : 'text-slate-400'}">${m.name}</p>
                </div>`).join('');
        }

        function toggleSetupMember(id) {
            if (setupSelectedMembers.includes(id)) {
                setupSelectedMembers = setupSelectedMembers.filter(i => i !== id);
            } else if (setupSelectedMembers.length < 3) {
                setupSelectedMembers.push(id);
            }
            renderSetupMembers();
        }

        function setBet(b, r, btn) {
            document.querySelectorAll('.bet-btn').forEach(el => el.classList.remove('bet-active'));
            btn.classList.add('bet-active');
            if (b === 'custom') {
                document.getElementById('customBetArea').classList.remove('hidden');
                selectedBet = { base: 0, rate: 0 };
            } else {
                document.getElementById('customBetArea').classList.add('hidden');
                document.getElementById('betBase').value = b;
                document.getElementById('betRate').value = r;
                selectedBet = { base: b, rate: r };
            }
        }

        function startMatch() {
            if (setupSelectedMembers.length !== 3) return alert('è«‹é¸æ“‡ 3 ä½ç‰Œå’–');
            const base = parseInt(document.getElementById('betBase').value);
            const rate = parseInt(document.getElementById('betRate').value);
            if (isNaN(base) || isNaN(rate)) return alert('è«‹è¨­å®šè³­æ³¨');

            const members = DB.members.filter(m => setupSelectedMembers.includes(m.id));
            activeMatch = {
                id: 'm_' + Date.now(),
                date: document.getElementById('setupDate').value,
                loc: document.getElementById('setupLoc').value || 'æœªå¡«å¯«',
                bets: `${base}/${rate}`,
                opponents: members,
                rounds: [],
                currentLogs: [],
                overallTotal: 0,
                stats: { h:0, m:0, f:0, b:0 },
                memberScores: {}
            };
            members.forEach(m => activeMatch.memberScores[m.id] = 0);

            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('recordView').classList.remove('hidden');
            document.getElementById('liveBetInfo').innerText = activeMatch.bets;
            updateRecordUI();
            toggleRecTypeUI();
        }

        function toggleRecTypeUI() {
            const type = document.getElementById('recType').value;
            const normal = document.getElementById('normalInputArea');
            const selfDraw = document.getElementById('selfDrawInputArea');
            
            if (type === 'è‡ªæ‘¸') {
                normal.classList.add('hidden');
                selfDraw.classList.remove('hidden');
                document.getElementById('selfDrawFields').innerHTML = activeMatch.opponents.map(m => `
                    <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl">
                        <span class="text-xl">${m.emoji}</span>
                        <span class="flex-1 font-bold text-sm">${m.name}</span>
                        <input type="number" class="sd-input w-24 p-2 rounded-lg border-0 bg-white font-black text-right outline-none focus:ring-1 focus:ring-emerald-500" data-mid="${m.id}" placeholder="é‡‘é¡">
                    </div>
                `).join('');
            } else {
                normal.classList.remove('hidden');
                selfDraw.classList.add('hidden');
                const targetList = document.getElementById('recTargetList');
                targetList.innerHTML = activeMatch.opponents.map(m => `
                    <button onclick="selectedRecMember='${m.id}'; updateTargetUI()" class="target-btn flex-shrink-0 px-4 py-2 rounded-xl bg-slate-50 font-bold border-2 ${selectedRecMember === m.id ? 'border-emerald-500 bg-emerald-50 text-emerald-600' : 'border-transparent'}">
                        ${m.emoji} ${m.name}
                    </button>
                `).join('');
            }
        }

        function syncSelfDrawValues() {
            const inputs = document.querySelectorAll('.sd-input');
            if (inputs.length === 0) return;
            const firstVal = inputs[0].value;
            inputs.forEach(input => input.value = firstVal);
        }

        function updateTargetUI() {
            const btns = document.querySelectorAll('.target-btn');
            btns.forEach(b => b.className = b.className.replace('border-emerald-500 bg-emerald-50 text-emerald-600', 'border-transparent'));
            toggleRecTypeUI();
        }

        function addLog() {
            const type = document.getElementById('recType').value;
            const logId = Date.now();
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            if (type === 'è‡ªæ‘¸') {
                let roundWin = 0;
                let subData = [];
                const inputs = document.querySelectorAll('.sd-input');
                let allFilled = true;
                inputs.forEach(input => {
                    const val = parseInt(input.value);
                    if (isNaN(val)) allFilled = false;
                });
                if (!allFilled) return alert('è«‹å¡«å¯«æ‰€æœ‰äººçš„çµ¦ä»˜é‡‘é¡');

                inputs.forEach(input => {
                    const val = parseInt(input.value) || 0;
                    const mid = input.dataset.mid;
                    activeMatch.memberScores[mid] -= val;
                    roundWin += val;
                    subData.push({ mid, val });
                });
                activeMatch.overallTotal += roundWin;
                activeMatch.stats.m++;
                activeMatch.currentLogs.push({ id: logId, time, type, score: roundWin, subData });
            } else {
                const val = parseInt(document.getElementById('recVal').value);
                if (isNaN(val)) return alert('è«‹è¼¸å…¥é‡‘é¡');
                if (!selectedRecMember) return alert('è«‹é¸æ“‡æˆå“¡');
                const score = (type === 'èƒ¡ç‰Œ') ? val : -val;
                
                activeMatch.overallTotal += score;
                activeMatch.memberScores[selectedRecMember] -= score;
                
                if (type === 'èƒ¡ç‰Œ') activeMatch.stats.h++;
                if (type === 'æ”¾æ§') activeMatch.stats.f++;
                if (type === 'è¢«è‡ªæ‘¸') activeMatch.stats.b++;

                activeMatch.currentLogs.push({ 
                    id: logId, time, type, score, 
                    target: activeMatch.opponents.find(o => o.id === selectedRecMember).name,
                    targetId: selectedRecMember
                });
            }
            updateRecordUI();
            document.getElementById('recVal').value = '';
        }

        function updateRecordUI() {
            const netEl = document.getElementById('liveNet');
            netEl.innerText = `$ ${activeMatch.overallTotal.toLocaleString()}`;
            netEl.className = `text-6xl font-black mt-1 ${activeMatch.overallTotal >= 0 ? 'text-emerald-400' : 'text-red-400'}`;
            document.getElementById('liveRoundInfo').innerText = `ç¬¬ ${activeMatch.rounds.length + 1} å°‡`;
            
            document.getElementById('logList').innerHTML = activeMatch.currentLogs.slice().reverse().map(l => `
                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl mb-1 text-sm">
                    <div>
                        <span class="text-[10px] text-slate-400 block">${l.time}</span>
                        <span class="font-bold">${l.type} ${l.target || 'ä¸‰å®¶'}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-black ${l.score >= 0 ? 'text-emerald-600' : 'text-red-600'}">${l.score > 0 ? '+' : ''}${l.score}</span>
                        <button onclick="deleteLog(${l.id})" class="text-slate-300">âœ•</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteLog(id) {
            const logIdx = activeMatch.currentLogs.findIndex(l => l.id === id);
            if (logIdx === -1) return;
            const log = activeMatch.currentLogs[logIdx];

            activeMatch.overallTotal -= log.score;
            if (log.type === 'è‡ªæ‘¸') {
                log.subData.forEach(s => activeMatch.memberScores[s.mid] += s.val);
                activeMatch.stats.m--;
            } else {
                activeMatch.memberScores[log.targetId] += log.score;
                if (log.type === 'èƒ¡ç‰Œ') activeMatch.stats.h--;
                if (log.type === 'æ”¾æ§') activeMatch.stats.f--;
                if (log.type === 'è¢«è‡ªæ‘¸') activeMatch.stats.b--;
            }
            activeMatch.currentLogs.splice(logIdx, 1);
            updateRecordUI();
        }

        function nextRound() {
            // å­˜å…¥ç•¶å‰å°‡çš„æ‰€æœ‰æ—¥èªŒèˆ‡ç›ˆè™§
            const roundTotal = activeMatch.currentLogs.reduce((acc, l) => acc + l.score, 0);
            activeMatch.rounds.push({
                total: roundTotal,
                logs: [...activeMatch.currentLogs]
            });
            activeMatch.currentLogs = [];
            updateRecordUI();
            alert(`ç¬¬ ${activeMatch.rounds.length} å°‡è³‡æ–™å·²æš«å­˜`);
        }

        function confirmSettle() {
            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <div class="text-center">
                    <h2 class="text-2xl font-black mb-4">ç¢ºå®šçµç®—ï¼Ÿ</h2>
                    <p class="text-slate-500 mb-8 font-bold">çµç®—å¾Œå°‡ä¿å­˜æ•¸æ“šè‡³æ—¥æ›†èˆ‡æˆå“¡è¨˜éŒ„ã€‚</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="closeModal()" class="py-4 bg-slate-100 rounded-2xl font-bold">å–æ¶ˆ</button>
                        <button onclick="settleMatch()" class="py-4 bg-emerald-600 text-white rounded-2xl font-bold">çµç®—</button>
                    </div>
                </div>
            `;
            openModal();
        }

        async function settleMatch() {
            if (activeMatch.currentLogs.length > 0) {
                const roundTotal = activeMatch.currentLogs.reduce((acc, l) => acc + l.score, 0);
                activeMatch.rounds.push({
                    total: roundTotal,
                    logs: [...activeMatch.currentLogs]
                });
            }
            
            const m = activeMatch;
            const finalData = {
                id: m.id,
                date: m.date,
                loc: m.loc,
                bets: m.bets,
                rounds: m.rounds,
                total: m.overallTotal,
                stats: m.stats,
                memberScores: m.memberScores
            };

            DB.matches.unshift(finalData);

            m.opponents.forEach(opp => {
                const dbMem = DB.members.find(x => x.id === opp.id);
                if (dbMem) {
                    if (!dbMem.records) dbMem.records = [];
                    dbMem.records.unshift({
                        date: m.date,
                        score: m.memberScores[opp.id]
                    });
                }
            });

            await saveCloud();
            
            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="text-center">
                        <p class="text-[10px] font-bold text-emerald-600 uppercase">ç‰Œå±€æˆ°å ± (è³­æ³¨: ${m.bets})</p>
                        <h2 class="text-4xl font-black ${m.overallTotal >= 0 ? 'text-emerald-600' : 'text-red-600'}">$ ${m.overallTotal}</h2>
                    </div>
                    <div class="space-y-4">
                        <p class="text-xs font-black text-slate-400">å„å°‡ç›ˆè™§ï¼š</p>
                        <div class="grid grid-cols-3 gap-2">
                            ${m.rounds.map((r, i) => `
                                <div class="bg-slate-50 p-2 rounded-xl text-center">
                                    <p class="text-[8px] text-slate-400">ç¬¬ ${i+1} å°‡</p>
                                    <p class="font-bold text-xs ${r.total >= 0 ? 'text-emerald-600' : 'text-red-600'}">${r.total}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-xs font-bold text-slate-400">èˆ‡ç‰Œå’–ç›ˆè™§ï¼š</p>
                        ${m.opponents.map(opp => `
                            <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl">
                                <span class="font-bold">${opp.emoji} ${opp.name}</span>
                                <span class="font-black ${m.memberScores[opp.id] >= 0 ? 'text-emerald-500' : 'text-red-500'}">
                                    ${m.memberScores[opp.id] > 0 ? '+' : ''}${m.memberScores[opp.id]}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="finishSettle()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black">é—œé–‰</button>
                </div>
            `;
            openModal();
        }

        function finishSettle() {
            activeMatch = null;
            setupSelectedMembers = [];
            closeModal();
            switchTab('dashboard');
            document.getElementById('recordView').classList.add('hidden');
            document.getElementById('setupView').classList.remove('hidden');
        }

        // --- æˆå“¡é é¢åŠŸèƒ½ ---
        function addMember() {
            const name = document.getElementById('memName').value.trim();
            if (!name) return;
            DB.members.push({
                id: 'mem_' + Date.now(),
                name: name,
                emoji: selectedEmoji,
                records: []
            });
            saveCloud();
            document.getElementById('memName').value = '';
            renderMemberList();
            renderSetupMembers();
        }

        function renderMemberList() {
            const yearSelect = document.getElementById('memYearSelect');
            const year = yearSelect ? yearSelect.value : 'all';
            const display = document.getElementById('memberListDisplay');
            
            const scoredMembers = DB.members.map(m => {
                const yearScore = (m.records || [])
                    .filter(r => year === 'all' || r.date.startsWith(year))
                    .reduce((acc, r) => acc + r.score, 0);
                return { ...m, currentScore: yearScore };
            });

            // è² å€¼ç‚ºè¼¸çµ¦æˆ‘ (é‡‘ä¸»), æ­£å€¼ç‚ºè´æˆ‘éŒ¢ (å‚µä¸»)
            let king = null, debtor = null;
            if (scoredMembers.length > 0) {
                const sortedByWin = [...scoredMembers].sort((a,b) => a.currentScore - b.currentScore); // ç”±å°åˆ°å¤§
                if (sortedByWin[0].currentScore < 0) king = sortedByWin[0]; // è² æœ€å¤šçš„
                
                const sortedByLoss = [...scoredMembers].sort((a,b) => b.currentScore - a.currentScore); // ç”±å¤§åˆ°å°
                if (sortedByLoss[0].currentScore > 0) debtor = sortedByLoss[0]; // æ­£æœ€å¤šçš„
            }

            const normalMembers = scoredMembers.filter(m => 
                (king ? m.id !== king.id : true) && (debtor ? m.id !== debtor.id : true)
            ).sort((a,b) => b.currentScore - a.currentScore);

            let html = '';
            if (king) html += renderMemberItem(king, 'bg-emerald-50 border-emerald-200', 'ğŸ’° å¤§é‡‘ä¸»');
            if (debtor) html += renderMemberItem(debtor, 'bg-red-50 border-red-200', 'ğŸ§§ å¤§å‚µä¸»');
            normalMembers.forEach(m => html += renderMemberItem(m, 'bg-white border-slate-100'));

            display.innerHTML = html || `<p class="text-center text-slate-400 py-8">å°šæœªæ–°å¢ä»»ä½•æˆå“¡</p>`;
        }

        function renderMemberItem(m, classStr, tag = '') {
            return `
                <div onclick="showMemberDetail('${m.id}')" class="member-card p-5 rounded-[28px] border shadow-sm flex justify-between items-center ${classStr}">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-2xl shadow-sm">${m.emoji}</div>
                        <div>
                            ${tag ? `<span class="text-[8px] font-black uppercase px-2 py-0.5 rounded-full bg-white border mb-1 inline-block">${tag}</span>` : ''}
                            <h4 class="font-black text-slate-800">${m.name}</h4>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-slate-400">èˆ‡æˆ‘å‹è² </p>
                        <p class="font-black ${m.currentScore >= 0 ? 'text-emerald-600' : 'text-red-600'}">${m.currentScore > 0 ? '+' : ''}${m.currentScore}</p>
                    </div>
                </div>
            `;
        }

        // --- è©³æƒ…èˆ‡åˆªé™¤ ---
        function showDailyMatches(dateStr) {
            const matches = DB.matches.filter(m => m.date === dateStr);
            if (matches.length === 0) return;

            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <div class="space-y-4">
                    <h3 class="text-xl font-black text-slate-800">${dateStr} æˆ°ç¸¾</h3>
                    <div class="space-y-2">
                        ${matches.map((m, idx) => `
                            <button onclick="showMatchDetail('${m.id}')" class="w-full p-4 bg-slate-50 rounded-2xl flex justify-between items-center border hover:border-emerald-500 transition-all">
                                <div class="text-left">
                                    <span class="text-[10px] font-bold text-slate-400">è³­æ³¨: ${m.bets}</span>
                                    <p class="font-bold">${m.loc}</p>
                                </div>
                                <span class="font-black ${m.total >= 0 ? 'text-emerald-600' : 'text-red-600'}">${m.total > 0 ? '+' : ''}${m.total}</span>
                            </button>
                        `).join('')}
                    </div>
                    <button onclick="closeModal()" class="w-full py-4 bg-slate-100 rounded-2xl font-bold">è¿”å›</button>
                </div>
            `;
            openModal();
        }

        function showMatchDetail(matchId) {
            const m = DB.matches.find(x => x.id === matchId);
            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between items-start">
                        <button onclick="showDailyMatches('${m.date}')" class="text-slate-400 font-bold">â—€ è¿”å›åˆ—è¡¨</button>
                        <button onclick="confirmDeleteMatch('${m.id}')" class="text-red-400 font-bold">ğŸ—‘ï¸ åˆªé™¤å ´æ¬¡</button>
                    </div>
                    <div class="text-center pt-4">
                        <h3 class="text-3xl font-black ${m.total >= 0 ? 'text-emerald-600' : 'text-red-600'}">$ ${m.total}</h3>
                        <p class="text-xs text-slate-400 font-bold mt-1">${m.date} | è³­æ³¨ ${m.bets}</p>
                    </div>
                    <div class="space-y-3">
                        <p class="text-xs font-black text-slate-400">åˆ†å°‡è©³æƒ…ï¼š</p>
                        ${m.rounds.map((r, i) => `
                            <div class="bg-slate-50 p-3 rounded-xl flex justify-between text-sm">
                                <span class="font-bold">ç¬¬ ${i+1} å°‡</span>
                                <span class="font-black ${r.total >= 0 ? 'text-emerald-600' : 'text-red-600'}">${r.total >= 0 ? '+' : ''}${r.total}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="space-y-2">
                         <p class="text-xs font-black text-slate-400">èˆ‡ç‰Œå’–ç›ˆè™§ï¼š</p>
                        ${Object.entries(m.memberScores).map(([mid, score]) => {
                            const mem = DB.members.find(x => x.id === mid) || {name: 'å·²åˆªé™¤', emoji: 'ğŸ‘¤'};
                            return `
                                <div class="flex justify-between text-sm border-b pb-2">
                                    <span>${mem.emoji} ${mem.name}</span>
                                    <span class="font-bold ${score >= 0 ? 'text-emerald-500' : 'text-red-500'}">${score > 0 ? '+' : ''}${score}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function confirmDeleteMatch(id) {
            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <div class="text-center">
                    <h2 class="text-2xl font-black mb-4">åˆªé™¤æ­¤å ´æ¬¡ï¼Ÿ</h2>
                    <p class="text-slate-500 mb-8 font-bold text-sm text-red-500">æ­¤å‹•ä½œå°‡åŒæ™‚æ‰£é™¤æˆå“¡çš„å°æ‡‰æˆ°ç¸¾ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="closeModal()" class="py-4 bg-slate-100 rounded-2xl font-bold">å–æ¶ˆ</button>
                        <button onclick="deleteMatch('${id}')" class="py-4 bg-red-500 text-white rounded-2xl font-bold">ç¢ºèªåˆªé™¤</button>
                    </div>
                </div>
            `;
        }

        async function deleteMatch(id) {
            const match = DB.matches.find(m => m.id === id);
            if (!match) return;

            // æ‰£å›æˆå“¡æ­·å²
            Object.entries(match.memberScores).forEach(([mid, score]) => {
                const mem = DB.members.find(x => x.id === mid);
                if (mem && mem.records) {
                    const rIdx = mem.records.findIndex(r => r.date === match.date && r.score === score);
                    if (rIdx !== -1) mem.records.splice(rIdx, 1);
                }
            });

            DB.matches = DB.matches.filter(m => m.id !== id);
            await saveCloud();
            closeModal();
            updateDashboard();
        }

        function showMemberDetail(id) {
            const m = DB.members.find(x => x.id === id);
            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-slate-50 rounded-3xl flex items-center justify-center text-4xl mx-auto shadow-sm mb-4">${m.emoji}</div>
                        <h3 class="text-2xl font-black">${m.name}</h3>
                    </div>
                    <div class="max-h-60 overflow-y-auto space-y-2 pr-2">
                        ${(m.records || []).map(r => `
                            <div class="flex justify-between text-sm border-b pb-2">
                                <span class="text-slate-400 font-bold">${r.date}</span>
                                <span class="font-black ${r.score >= 0 ? 'text-emerald-500' : 'text-red-500'}">${r.score > 0 ? '+' : ''}${r.score}</span>
                            </div>
                        `).join('') || '<p class="text-center text-slate-300">ç„¡æ­·å²è¨˜éŒ„</p>'}
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="editMemberUI('${m.id}')" class="py-4 bg-slate-100 rounded-2xl font-bold">ç·¨è¼¯</button>
                        <button onclick="closeModal()" class="py-4 bg-slate-900 text-white rounded-2xl font-bold">é—œé–‰</button>
                    </div>
                </div>
            `;
            openModal();
        }

        function editMemberUI(id) {
            const m = DB.members.find(x => x.id === id);
            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <div class="space-y-6">
                    <h3 class="text-xl font-black">ç·¨è¼¯æˆå“¡</h3>
                    <div id="editEmojiGrid" class="grid grid-cols-5 gap-2 max-h-40 overflow-y-auto bg-slate-50 p-2 rounded-xl">
                        ${animals.map(e => `<button onclick="window.tempEmoji='${e}'; updateEditEmojiUI(this)" class="emoji-btn ${e === m.emoji ? 'selected' : ''}">${e}</button>`).join('')}
                    </div>
                    <input type="text" id="editMemName" value="${m.name}" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-bold outline-none ring-1 ring-slate-200">
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="confirmDeleteMember('${m.id}')" class="py-4 text-red-500 font-bold border border-red-100 rounded-2xl">åˆªé™¤æˆå“¡</button>
                        <button onclick="updateMember('${m.id}')" class="py-4 bg-emerald-600 text-white rounded-2xl font-bold">ä¿å­˜ä¿®æ”¹</button>
                    </div>
                </div>
            `;
            window.tempEmoji = m.emoji;
        }

        function updateEditEmojiUI(btn) {
            document.querySelectorAll('#editEmojiGrid .emoji-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        async function updateMember(id) {
            const m = DB.members.find(x => x.id === id);
            m.name = document.getElementById('editMemName').value.trim();
            m.emoji = window.tempEmoji;
            await saveCloud();
            closeModal();
            renderMemberList();
            renderSetupMembers();
        }

        function confirmDeleteMember(id) {
            const m = DB.members.find(x => x.id === id);
            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <div class="text-center">
                    <h2 class="text-2xl font-black mb-4">åˆªé™¤ ${m.name}ï¼Ÿ</h2>
                    <p class="text-slate-500 mb-8 font-bold text-sm">åˆªé™¤å¾Œæ­¤æˆå“¡å°‡ä¸å†å‡ºç¾åœ¨åˆ—è¡¨ä¸­ã€‚æ­·å²å°æˆ°æ•¸æ“šå°‡ä¿ç•™åç¨±ï¼Œä½†ç„¡æ³•å†èˆ‡ä¹‹å»ºç«‹æ–°å±€ã€‚</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="editMemberUI('${id}')" class="py-4 bg-slate-100 rounded-2xl font-bold">å–æ¶ˆ</button>
                        <button onclick="deleteMember('${id}')" class="py-4 bg-red-500 text-white rounded-2xl font-bold">ç¢ºèªåˆªé™¤</button>
                    </div>
                </div>
            `;
        }

        async function deleteMember(id) {
            DB.members = DB.members.filter(m => m.id !== id);
            setupSelectedMembers = setupSelectedMembers.filter(mid => mid !== id);
            await saveCloud();
            closeModal();
            renderMemberList();
            renderSetupMembers();
        }

        function openModal() { document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

    </script>
</body>
</html>
