<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»å°‡å¤§å¸«è¨ˆåˆ†å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { background-color: #f1f5f9; font-family: 'Noto Sans TC', sans-serif; padding-bottom: 40px; }
        .tab-active { color: #059669; border-bottom: 4px solid #059669; }
        .calendar-day { aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.875rem; cursor: pointer; position: relative; transition: all 0.2s; }
        .day-win { background-color: #22c55e !important; color: white; box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.4); }
        .day-loss { background-color: #ef4444 !important; color: white; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.4); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .bet-active { background-color: #059669 !important; color: white !important; }
        #loading-overlay { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .error-msg { background: #fee2e2; border: 1px solid #f87171; color: #991b1b; padding: 1rem; border-radius: 1rem; margin-top: 1rem; font-size: 0.875rem; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mb-4"></div>
        <p class="font-bold text-slate-500">é›²ç«¯è³‡æ–™åŒæ­¥ä¸­...</p>
        <div id="auth-error-hint" class="hidden max-w-xs text-center px-4">
            <div class="error-msg">
                åµæ¸¬åˆ° Firebase è¨­å®šéŒ¯èª¤ã€‚<br>
                è«‹ç¢ºä¿å·²åœ¨ Firebase æ§åˆ¶å°å•Ÿç”¨ã€ŒåŒ¿åç™»å…¥ (Anonymous)ã€ã€‚
            </div>
        </div>
    </div>

    <div class="max-w-md mx-auto min-h-screen flex flex-col shadow-2xl bg-slate-50 relative overflow-hidden">
        <!-- å°è¦½åˆ— -->
        <nav class="sticky top-0 z-40 bg-white/95 backdrop-blur shadow-sm flex border-b">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="flex-1 py-4 font-black text-center tab-active">ç¸½è¦½</button>
            <button onclick="switchTab('tracker')" id="tab-tracker" class="flex-1 py-4 font-black text-center text-slate-400">è¨ˆåˆ†</button>
            <button onclick="switchTab('members')" id="tab-members" class="flex-1 py-4 font-black text-center text-slate-400">æˆå“¡</button>
        </nav>

        <main class="p-4 flex-grow overflow-x-hidden">
            <!-- ç¸½è¦½é é¢ -->
            <section id="page-dashboard" class="space-y-4">
                <div class="glass-card rounded-3xl p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-slate-800">æ•¸æ“šçµ±è¨ˆ</h3>
                        <select id="dashYearSelect" onchange="renderDashboard()" class="bg-slate-100 border-none rounded-lg px-2 py-1 text-sm font-bold">
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div id="netProfitBox" class="col-span-2 rounded-2xl p-5 text-center text-white transition-colors bg-emerald-600 shadow-lg">
                            <p class="text-[10px] opacity-70 font-bold uppercase tracking-wider">æ·¨å‹è² </p>
                            <h2 id="dashNet" class="text-4xl font-black mt-1">$ 0</h2>
                        </div>
                        <div class="bg-emerald-50 rounded-2xl p-3 border border-emerald-100 text-center">
                            <p class="text-[10px] text-emerald-600 font-bold">å–®å ´æœ€é«˜è´</p>
                            <p id="dashWin" class="text-xl font-black text-emerald-700">$ 0</p>
                        </div>
                        <div class="bg-red-50 rounded-2xl p-3 border border-red-100 text-center">
                            <p class="text-[10px] text-red-600 font-bold">å–®å ´æœ€é«˜è¼¸</p>
                            <p id="dashLoss" class="text-xl font-black text-red-700">$ 0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="calTitle" class="font-black text-slate-800">2025å¹´ 1æœˆ</h3>
                        <div class="flex gap-2">
                            <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full">â—€</button>
                            <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full">â–¶</button>
                        </div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
                </div>
            </section>

            <!-- è¨ˆåˆ†é é¢ -->
            <section id="page-tracker" class="hidden">
                <div id="setupView" class="space-y-4">
                    <div class="bg-white rounded-3xl p-6 shadow-sm space-y-6">
                        <h2 class="text-2xl font-black text-slate-800">å»ºç«‹æ–°ç‰Œå±€</h2>
                        <input type="date" id="setupDate" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
                        <p class="text-xs font-bold text-slate-400">è«‹é¸å– 3 ä½ç‰Œå’–å°æ‰‹ï¼š</p>
                        <div id="setupMemberList" class="flex gap-3 overflow-x-auto pb-2 scroll-hide min-h-[80px]"></div>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setBet(30,10,this)" class="bet-btn py-3 bg-slate-100 rounded-xl text-xs font-black">30/10</button>
                            <button onclick="setBet(50,20,this)" class="bet-btn py-3 bg-slate-100 rounded-xl text-xs font-black">50/20</button>
                            <button onclick="setBet(100,20,this)" class="bet-btn py-3 bg-slate-100 rounded-xl text-xs font-black">100/20</button>
                        </div>
                        <button onclick="startMatch()" class="w-full bg-emerald-600 text-white py-5 rounded-[24px] font-black shadow-xl">é–‹å§‹è¨ˆåˆ†</button>
                    </div>
                </div>
                <div id="recordView" class="hidden space-y-4">
                    <div class="bg-slate-900 text-white rounded-[32px] p-8">
                        <h2 id="liveNet" class="text-6xl font-black tracking-tighter">$ 0</h2>
                        <p class="mt-2 opacity-50 font-bold">ç•¶å‰å±€å‹¢ç´¯ç©ç¸½è¨ˆ</p>
                    </div>
                    <div class="bg-white rounded-[32px] p-6 space-y-4">
                        <select id="recType" class="w-full p-4 bg-slate-100 rounded-2xl font-black">
                            <option value="èƒ¡ç‰Œ">æˆ‘èƒ¡ç‰Œ (+)</option>
                            <option value="æ”¾æ§">æˆ‘æ”¾æ§ (-)</option>
                        </select>
                        <input type="number" id="recVal" placeholder="è¼¸å…¥é‡‘é¡" class="w-full p-4 bg-slate-100 rounded-2xl font-black outline-none">
                        <p class="text-xs font-bold text-slate-400">é¸æ“‡è¨ˆç®—å°è±¡ï¼š</p>
                        <div id="recTargetList" class="flex gap-2 overflow-x-auto py-2 scroll-hide"></div>
                        <button onclick="addLog()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black">æ–°å¢æ­¤ç´€éŒ„</button>
                        <button onclick="settleMatch()" class="w-full bg-orange-500 text-white py-4 rounded-2xl font-black mt-2">ç‰Œå±€çµæŸä¸¦å­˜æª”</button>
                    </div>
                </div>
            </section>

            <!-- æˆå“¡é é¢ -->
            <section id="page-members" class="hidden space-y-6">
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <h2 class="text-xl font-black text-slate-800 mb-4">æ–°å¢æˆå“¡</h2>
                    <div class="flex gap-2">
                        <input type="text" id="memName" placeholder="è¼¸å…¥åå­—" class="flex-1 p-4 bg-slate-50 rounded-2xl border-none font-bold outline-none">
                        <button onclick="addMember()" class="bg-emerald-600 text-white px-8 rounded-2xl font-black">æ–°å¢</button>
                    </div>
                </div>
                <div id="memberListDisplay" class="space-y-3"></div>
            </section>
        </main>
    </div>

    <!-- Firebase é‚è¼¯ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // æ›´æ–°å¾Œçš„ Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyAX-Lsh3RdVZWf6oV5TAH-OS4BD__h4DuQ",
            authDomain: "mahjong-scoring-calculat-3c0ca.firebaseapp.com",
            projectId: "mahjong-scoring-calculat-3c0ca",
            storageBucket: "mahjong-scoring-calculat-3c0ca.firebasestorage.app",
            messagingSenderId: "386600276534",
            appId: "1:386600276534:web:2eefd6ee6eba7ae9927e97",
            measurementId: "G-HNKLDG0P3L"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let DB = { members: [], matches: [] };
        let user = null;
        const appId = "mahjong-app-v3";
        let viewDate = new Date();
        let setupSelectedMembers = [];
        let activeMatch = null;
        let selectedRecMember = null;

        // åˆå§‹åŒ–
        signInAnonymously(auth).catch((error) => {
            console.error("Auth Error:", error.code);
            if (error.code === 'auth/configuration-not-found') {
                document.getElementById('auth-error-hint').classList.remove('hidden');
            }
        });

        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'mahjongDB'), (snap) => {
                    if (snap.exists()) {
                        DB = snap.data();
                    } else {
                        saveCloud(); // åˆå§‹åŒ–
                    }
                    renderUI();
                    document.getElementById('loading-overlay').style.opacity = '0';
                    setTimeout(() => document.getElementById('loading-overlay').classList.add('hidden'), 500);
                }, (err) => {
                    console.error("Firestore Error:", err);
                });
            }
        });

        async function saveCloud() {
            if (!user) return;
            await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'mahjongDB'), DB);
        }

        // --- æ§åˆ¶å‡½å¼ ---
        window.switchTab = (tab) => {
            document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`page-${tab}`).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('tab-active', 'text-slate-400'));
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            renderUI();
        };

        window.addMember = async () => {
            const name = document.getElementById('memName').value.trim();
            if (!name) return;
            DB.members.push({ id: 'mem_'+Date.now(), name, emoji: 'ğŸ€„', records: [] });
            await saveCloud();
            document.getElementById('memName').value = '';
            renderMemberList();
        };

        window.setBet = (base, rate, btn) => {
            document.querySelectorAll('.bet-btn').forEach(b => b.classList.remove('bet-active'));
            btn.classList.add('bet-active');
        };

        window.startMatch = () => {
            if (setupSelectedMembers.length !== 3) return alert('è«‹å…ˆé»é¸ä¸‹æ–¹é ­åƒï¼Œé¸æ“‡ä¸‰ä½å°æ‰‹ï¼');
            activeMatch = {
                id: 'm_'+Date.now(),
                date: document.getElementById('setupDate').value,
                overallTotal: 0,
                memberScores: {},
                members: DB.members.filter(m => setupSelectedMembers.includes(m.id))
            };
            activeMatch.members.forEach(m => activeMatch.memberScores[m.name] = 0);
            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('recordView').classList.remove('hidden');
            updateRecordUI();
        };

        window.addLog = () => {
            const val = parseInt(document.getElementById('recVal').value) || 0;
            const type = document.getElementById('recType').value;
            if (!selectedRecMember) return alert('è«‹å…ˆé»æ“Šé¸å–ä¸‹æ–¹å…¶ä¸­ä¸€ä½æˆå“¡ï¼');
            
            const m = activeMatch.members.find(x => x.id === selectedRecMember);
            if (type === 'èƒ¡ç‰Œ') {
                activeMatch.overallTotal += val;
                activeMatch.memberScores[m.name] -= val;
            } else {
                activeMatch.overallTotal -= val;
                activeMatch.memberScores[m.name] += val;
            }
            document.getElementById('recVal').value = '';
            updateRecordUI();
        };

        window.settleMatch = async () => {
            DB.matches.unshift({ 
                date: activeMatch.date, 
                total: activeMatch.overallTotal, 
                memberScores: activeMatch.memberScores 
            });
            activeMatch.members.forEach(mem => {
                const dbMem = DB.members.find(x => x.id === mem.id);
                if (dbMem) dbMem.records.unshift({ date: activeMatch.date, score: activeMatch.memberScores[mem.name] });
            });
            activeMatch = null;
            setupSelectedMembers = [];
            await saveCloud();
            document.getElementById('recordView').classList.add('hidden');
            document.getElementById('setupView').classList.remove('hidden');
            switchTab('dashboard');
        };

        // --- UI æ¸²æŸ“ ---
        function renderUI() {
            renderMemberList();
            renderDashboard();
            renderSetupMembers();
            if (!document.getElementById('setupDate').value) {
                document.getElementById('setupDate').valueAsDate = new Date();
            }
        }

        function renderMemberList() {
            const display = document.getElementById('memberListDisplay');
            if (!DB.members.length) {
                display.innerHTML = '<p class="text-center text-slate-400 py-10 font-bold">è«‹åˆ°ã€Œæˆå“¡ã€é é¢æ–°å¢ç‰Œå’–</p>';
                return;
            }
            const sorted = [...DB.members].sort((a,b) => {
                const sA = a.records.reduce((acc, r) => acc + r.score, 0);
                const sB = b.records.reduce((acc, r) => acc + r.score, 0);
                return sA - sB;
            });

            display.innerHTML = sorted.map((m, i) => {
                const total = m.records.reduce((acc, r) => acc + r.score, 0);
                let color = "bg-white";
                if (i === 0 && total < 0) color = "bg-emerald-500 text-white shadow-emerald-200";
                if (i === sorted.length - 1 && total > 0) color = "bg-red-500 text-white shadow-red-200";
                return `
                    <div class="p-5 rounded-[28px] flex justify-between items-center ${color} shadow-sm border border-slate-100">
                        <span class="font-black">${m.emoji} ${m.name}</span>
                        <div class="text-right">
                            <span class="text-[10px] block opacity-50">ç´¯è¨ˆæ”¶ç›Š</span>
                            <span class="font-black text-xl">${total >= 0 ? '+' : ''}${total}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.renderDashboard = () => {
            const net = DB.matches.reduce((acc, m) => acc + m.total, 0);
            document.getElementById('dashNet').innerText = `$ ${net}`;
            document.getElementById('netProfitBox').className = `col-span-2 rounded-2xl p-5 text-center text-white shadow-lg transition-colors ${net >= 0 ? 'bg-emerald-600' : 'bg-red-600'}`;
            
            const maxWin = DB.matches.length ? Math.max(...DB.matches.map(m => m.total)) : 0;
            const maxLoss = DB.matches.length ? Math.min(...DB.matches.map(m => m.total)) : 0;
            document.getElementById('dashWin').innerText = `$ ${maxWin > 0 ? maxWin : 0}`;
            document.getElementById('dashLoss').innerText = `$ ${maxLoss < 0 ? Math.abs(maxLoss) : 0}`;

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            document.getElementById('calTitle').innerText = `${viewDate.getFullYear()}å¹´ ${viewDate.getMonth() + 1}æœˆ`;
            
            const lastDay = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
            for (let d = 1; d <= lastDay; d++) {
                const dayStr = `${viewDate.getFullYear()}-${String(viewDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const match = DB.matches.find(m => m.date === dayStr);
                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day ${match ? (match.total >= 0 ? 'day-win' : 'day-loss') : 'bg-white text-slate-300'} font-bold`;
                dayEl.innerText = d;
                grid.appendChild(dayEl);
            }
        }

        function renderSetupMembers() {
            const list = document.getElementById('setupMemberList');
            list.innerHTML = DB.members.map(m => `
                <div onclick="toggleSetup('${m.id}')" class="flex-shrink-0 w-16 h-16 rounded-2xl flex flex-col items-center justify-center text-xs font-bold border-2 transition-all ${setupSelectedMembers.includes(m.id) ? 'border-emerald-500 bg-emerald-50 text-emerald-700' : 'border-transparent bg-slate-100 text-slate-400'}">
                    <span class="text-2xl mb-1">${m.emoji}</span>
                    ${m.name}
                </div>
            `).join('');
        }

        window.toggleSetup = (id) => {
            if (setupSelectedMembers.includes(id)) setupSelectedMembers = setupSelectedMembers.filter(x => x !== id);
            else if (setupSelectedMembers.length < 3) setupSelectedMembers.push(id);
            renderSetupMembers();
        };

        function updateRecordUI() {
            document.getElementById('liveNet').innerText = `$ ${activeMatch.overallTotal}`;
            document.getElementById('recTargetList').innerHTML = activeMatch.members.map(m => `
                <button onclick="window.setRecMember('${m.id}')" class="px-6 py-3 rounded-2xl text-sm font-black whitespace-nowrap transition-all ${selectedRecMember === m.id ? 'bg-slate-900 text-white shadow-lg' : 'bg-slate-100 text-slate-500'}">
                    ${m.name}
                </button>
            `).join('');
        }

        window.setRecMember = (id) => {
            selectedRecMember = id;
            updateRecordUI();
        };

        window.changeMonth = (s) => { 
            viewDate.setMonth(viewDate.getMonth() + s); 
            renderDashboard(); 
        };
    </script>
</body>
</html>
